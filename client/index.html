<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Governance Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Critical styles - inline to ensure they load even if external CSS fails */
        .hidden {
            display: none !important;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- Login Section -->
    <div id="auth-section" class="container login-container">
        <!-- Login Form -->
        <div id="login-card" class="card">
            <h2>Sign In</h2>
            <div id="login-error" class="hidden" style="color: red; margin-bottom: 1rem;"></div>
            <form onsubmit="handleLogin(event)">
                <div>
                    <label>Username</label>
                    <input type="text" id="username" placeholder="admin" required>
                </div>
                <div>
                    <label>Password</label>
                    <input type="password" id="password" placeholder="admin123" required>
                </div>
                <button type="submit" class="btn-primary btn-full">Login to Platform</button>
            </form>
            <p style="text-align: center; color: #666; font-size: 0.875rem; margin-top: 1rem;">
                Don't have an account? <button class="link-btn" onclick="toggleAuth('register')">Register here</button>
            </p>
        </div>

        <!-- Register Form -->
        <div id="register-card" class="card hidden">
            <h2>Create Account</h2>
            <div id="register-error" class="hidden" style="color: red; margin-bottom: 1rem;"></div>
            <div id="register-success" class="hidden" style="color: green; margin-bottom: 1rem;"></div>
            <form onsubmit="handleRegister(event)">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label>First Name</label>
                        <input type="text" id="reg-firstname" required>
                    </div>
                    <div>
                        <label>Last Name</label>
                        <input type="text" id="reg-lastname" required>
                    </div>
                </div>
                <div>
                    <label>Email Address</label>
                    <input type="email" id="reg-email" required>
                </div>
                <div>
                    <label>Username</label>
                    <input type="text" id="reg-username" required>
                </div>
                <div>
                    <label>Password</label>
                    <input type="password" id="reg-password" required>
                </div>
                <button type="submit" class="btn-primary btn-full">Register</button>
            </form>
            <p style="text-align: center; color: #666; font-size: 0.875rem; margin-top: 1rem;">
                Already have an account? <button class="link-btn" onclick="toggleAuth('login')">Login here</button>
            </p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app-container" class="hidden">
        <header>
            <div class="logo-section">
                <div class="logo-icon">üõ°Ô∏è</div>
                <div class="header-title">
                    <h1>Data Governance & Compliance Platform</h1>
                    <div class="header-subtitle">ISO 27001 / ISO/IEC 27017</div>
                </div>
            </div>
            <div class="user-controls">
                <button class="btn-outline">
                    <span id="system-status">System Active</span>
                </button>
                <div id="user-display" style="font-weight: 500;"></div>
                <button onclick="logout()" class="btn-primary" style="font-size: 0.875rem;">Logout</button>
            </div>
        </header>

        <div class="container">
            <!-- Tabs -->
            <div class="tabs-container">
                <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
                <button class="tab-btn" onclick="switchTab('compliance')">Compliance</button>
                <button class="tab-btn" onclick="switchTab('companies')">Companies</button>
                <button class="tab-btn" onclick="switchTab('data-quality')">Data Quality</button>
                <button class="tab-btn" onclick="switchTab('access')">Access Control</button>
                <button class="tab-btn" onclick="switchTab('documents')">Documents</button>
                <button class="tab-btn" onclick="switchTab('summary')">Summarize</button>
            </div>

            <!-- TAB 1: OVERVIEW -->
            <div id="tab-overview" class="tab-content">
                <!-- Metrics Row -->
                <div class="metrics-grid">
                    <!-- Compliance Card -->
                    <div class="card">
                        <div class="metric-header">
                            <span class="metric-title">Real-Time Compliance</span>
                            <span class="icon-success">‚úî</span>
                        </div>
                        <div class="metric-value" id="rt-score-compliance">Pending...</div>
                        <div class="metric-trend trend-up">
                            <span>‚Üó</span> <span id="rt-trend-compliance">Syncing...</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="rt-bar-compliance" style="width: 0%"></div>
                        </div>
                        <div style="font-size: 0.7rem; color: #999; margin-top: 5px;" id="rt-timestamp"></div>
                    </div>

                    <!-- Data Quality Card -->
                    <div class="card">
                        <div class="metric-header">
                            <span class="metric-title">Security Quality Score</span>
                            <span style="color: #2563eb">‚ö°</span>
                        </div>
                        <div class="metric-value" id="rt-score-quality">Pending...</div>
                        <div class="metric-trend trend-up">
                            <span>‚Üó</span> <span id="rt-trend-quality">Syncing...</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="rt-bar-quality" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Active Alerts -->
                    <div class="card">
                        <div class="metric-header">
                            <span class="metric-title">Active Alerts</span>
                            <span class="text-danger">‚ö†</span>
                        </div>
                        <div class="metric-value" id="score-alerts">--</div>
                        <div class="metric-trend trend-down">
                            <span>‚Üò</span> <span id="trend-alerts">-0 from last week</span>
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <span class="badge badge-high">High: <span id="alert-high">0</span></span>
                            <span class="badge badge-medium">Med: <span id="alert-med">0</span></span>
                            <span class="badge badge-low">Low: <span id="alert-low">0</span></span>
                        </div>
                    </div>

                    <!-- Pending Reviews -->
                    <div class="card">
                        <div class="metric-header">
                            <span class="metric-title">Pending Reviews</span>
                            <span class="text-warning">üïí</span>
                        </div>
                        <div class="metric-value" id="score-reviews">--</div>
                        <div class="metric-trend">
                            <span style="color: #666">Requires attention</span>
                        </div>
                        <button class="btn-outline" onclick="switchTab('documents')"
                            style="width: 100%; justify-content: center; margin-top: 1rem; cursor: pointer;">Review
                            Now</button>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="charts-grid">
                    <div class="card">
                        <h3>Compliance Trend</h3>
                        <p style="color: #666; font-size: 0.875rem; margin-bottom: 1rem;">6-month performance overview
                        </p>
                        <div class="chart-container">
                            <canvas id="complianceChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h3>ISO 27001 Controls</h3>
                        <p style="color: #666; font-size: 0.875rem; margin-bottom: 1rem;">Implementation status</p>
                        <div class="chart-container" style="display: flex; justify-content: center;">
                            <canvas id="controlsChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <h3>Recent Activity</h3>
                    <div class="activity-list" id="activity-feed">
                        <!-- Dynamic items -->
                    </div>
                </div>
            </div>

            <!-- TAB 2: COMPLIANCE -->
            <div id="tab-compliance" class="tab-content hidden">
                <div class="card">
                    <h3>Compliance Controls</h3>
                    <p style="color: #666; font-size: 0.9rem;">ISO 27001, ISO/IEC 27017, and SOC 2 Type II compliance
                        monitoring</p>

                    <!-- Company Filter -->
                    <div style="margin: 1.5rem 0; padding: 1rem; background: #f9fafb; border-radius: 0.5rem;">
                        <label
                            style="display: block; font-weight: 600; margin-bottom: 0.5rem; color: var(--text-primary);">
                            Select Company:
                        </label>
                        <select id="compliance-company-filter" class="filter-select"
                            onchange="filterComplianceByCompany()" style="width: 100%; max-width: 400px;">
                            <option value="">All Companies (Overview)</option>
                            <!-- Populated dynamically -->
                        </select>
                        <p id="compliance-company-info" style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
                        </p>
                    </div>

                    <div class="compliance-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <!-- Column 1 -->
                        <div class="control-group">
                            <h4>ISO 27001 Controls</h4>
                            <div id="iso27001-list"></div>
                        </div>

                        <!-- Column 2 -->
                        <div class="control-group">
                            <h4>ISO/IEC 27017 Cloud Controls</h4>
                            <div id="iso27017-list"></div>
                        </div>

                        <!-- Column 3 -->
                        <div class="control-group">
                            <h4>SOC 2 Type II</h4>
                            <div id="soc2-list"></div>
                        </div>

                        <!-- Column 4 -->
                        <div class="control-group">
                            <h4>Policy Acknowledgments</h4>
                            <div id="policy-list"></div>
                        </div>
                    </div>


                </div>
            </div>

            <!-- TAB: COMPANIES (Real Data from AnnualReports.com) -->
            <div id="tab-companies" class="tab-content hidden">
                <div class="card">
                    <h3>Company Data from AnnualReports.com</h3>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">Real annual reports and company
                        information for compliance analysis</p>

                    <!-- Statistics Summary -->
                    <div
                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; padding: 1.5rem 2rem; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <div
                            style="display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 2rem;">
                            <div style="text-align: center; color: white;">
                                <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;"
                                    id="total-companies-count">--</div>
                                <div
                                    style="font-size: 1rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px;">
                                    Companies</div>
                            </div>
                            <div style="width: 2px; height: 60px; background: rgba(255,255,255,0.3);"></div>
                            <div style="text-align: center; color: white;">
                                <div style="font-size: 2.5rem; font-weight: 700; margin-bottom: 0.5rem;"
                                    id="total-reports-count">--</div>
                                <div
                                    style="font-size: 1rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px;">
                                    Annual Reports</div>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 1rem; font-size: 0.875rem; color: rgba(255,255,255,0.8);"
                            id="stats-summary">
                            Loading statistics...
                        </div>
                    </div>

                    <!-- Search and Sort Controls -->
                    <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center;">
                        <!-- Search Bar -->
                        <div style="flex: 1; min-width: 250px; position: relative;">
                            <input type="text" id="company-search" placeholder="Search companies by name or ticker..."
                                style="width: 100%; padding: 0.75rem 1rem 0.75rem 2.5rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem; transition: all 0.2s;"
                                onkeyup="filterAndSortCompanies()"
                                onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                                onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'" />
                            <svg style="position: absolute; left: 0.875rem; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; color: #9ca3af;"
                                fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>

                        <!-- Sort Dropdown -->
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <label for="company-sort"
                                style="font-weight: 600; font-size: 0.9rem; color: #4b5563; white-space: nowrap;">Sort
                                by:</label>
                            <select id="company-sort" onchange="filterAndSortCompanies()"
                                style="padding: 0.75rem 2.5rem 0.75rem 1rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem; background-color: white; cursor: pointer; transition: all 0.2s;"
                                onfocus="this.style.borderColor='#667eea'; this.style.boxShadow='0 0 0 3px rgba(102,126,234,0.1)'"
                                onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                                <option value="reports-desc">Most Reports</option>
                                <option value="reports-asc">Fewest Reports</option>
                                <option value="ticker-asc">Ticker (A-Z)</option>
                            </select>
                        </div>

                        <!-- Results Count -->
                        <div style="font-size: 0.9rem; color: #6b7280; white-space: nowrap;">
                            <span id="filtered-count">0</span> <span id="filtered-label">companies</span>
                        </div>
                    </div>

                    <div id="companies-list" style="display: grid; gap: 1.5rem;">
                        <p style="color: #666;">Loading companies...</p>
                    </div>
                </div>
            </div>

            <!-- TAB 3: DATA QUALITY -->
            <div id="tab-data-quality" class="tab-content hidden">
                <div class="card">
                    <h3>All Companies Compliance Overview</h3>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">
                        ü§ñ AI-powered compliance analysis across all companies
                    </p>

                    <div
                        style="margin-bottom: 1.5rem; padding: 1rem; background: #f3f4f6; border-radius: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">Total Companies</div>
                            <div id="total-companies-count"
                                style="font-size: 1.5rem; font-weight: 700; color: #1e40af;">--</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">Average Compliance
                            </div>
                            <div id="average-compliance-score"
                                style="font-size: 1.5rem; font-weight: 700; color: #059669;">--</div>
                        </div>
                        <div>
                            <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">Highest Score</div>
                            <div id="highest-compliance-score"
                                style="font-size: 1.5rem; font-weight: 700; color: #7c3aed;">--</div>
                        </div>
                    </div>

                    <!-- Companies Compliance Bars -->
                    <div id="companies-compliance-chart" style="max-height: 600px; overflow-y: auto; padding: 0.5rem;">
                        <!-- Dynamic content will be inserted here -->
                    </div>
                </div>
            </div>

            <!-- TAB 4: ACCESS -->
            <div id="tab-access" class="tab-content hidden">
                <div class="card">
                    <h3>Access Control Management</h3>
                    <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1.5rem;">User permissions and
                        segregation of duties monitoring</p>

                    <div class="toolbar">
                        <input type="text" id="user-search" class="search-input" placeholder="Search users..."
                            oninput="filterAccessTable()">
                        <select id="role-filter" class="filter-select" onchange="filterAccessTable()">
                            <option value="">All Users</option>
                            <option value="Compliance Officer">Compliance Officers</option>
                            <option value="Data Steward">Data Stewards</option>
                            <option value="Viewer">Viewers</option>
                        </select>
                        <select id="time-filter" class="filter-select" onchange="filterAccessTable()">
                            <option value="30">30 days</option>
                            <option value="7">7 days</option>
                            <option value="1">24 hours</option>
                        </select>
                    </div>

                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Role</th>
                                <th>Permissions</th>
                                <th>Last Access</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="access-table-body">
                            <!-- Dynamic Data -->
                        </tbody>
                    </table>

                    <!-- Pending Document Reviews Section -->
                    <div style="margin-top: 3rem; border-top: 1px solid #e5e7eb; padding-top: 2rem;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="color: #1e3a8a; margin: 0;">Pending Document Reviews</h4>
                            <div>
                                <span id="debug-doc-count"
                                    style="font-size: 0.8rem; color: #666; margin-right: 1rem;"></span>
                                <button onclick="fetchComplianceDocs()" class="btn-sm"
                                    style="background: #f3f4f6; border: 1px solid #d1d5db;">Refresh List</button>
                            </div>
                        </div>
                        <div id="submitted-docs-list"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                            <!-- Populated by fetchComplianceDocs() -->
                            <p style="color: #6b7280; font-style: italic;">Loading pending reviews...</p>
                        </div>
                    </div>

                    <!-- Uploaded Documents Section -->
                    <div style="margin-top: 3rem; border-top: 1px solid #e5e7eb; padding-top: 2rem;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h4 style="color: #1e3a8a; margin: 0;">Uploaded Documents</h4>
                            <div>
                                <span id="uploaded-docs-count"
                                    style="font-size: 0.8rem; color: #666; margin-right: 1rem;"></span>
                                <button onclick="fetchAllDocuments()" class="btn-sm"
                                    style="background: #f3f4f6; border: 1px solid #d1d5db;">Refresh List</button>
                            </div>
                        </div>
                        <div id="all-docs-list"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                            <!-- Populated by fetchAllDocuments() -->
                            <p style="color: #6b7280; font-style: italic;">Loading documents...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: DOCUMENTS -->
            <div id="tab-documents" class="tab-content hidden">
                <div class="card">
                    <h3>Document Management</h3>
                    <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 2rem;">Upload and review compliance
                        documents</p>

                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 2rem;">
                        <!-- Upload Section -->
                        <div
                            style="background: #f9fafb; padding: 1.5rem; border-radius: 0.5rem; border: 1px solid var(--border-color);">
                            <h4 style="margin-bottom: 1rem;">Upload New Document</h4>
                            <form onsubmit="handleUpload(event)">
                                <div style="margin-bottom: 1rem;">
                                    <label
                                        style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Document
                                        Title</label>
                                    <input type="text" id="doc-title" required
                                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <label
                                        style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Description</label>
                                    <textarea id="doc-desc" rows="3"
                                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;"></textarea>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <label
                                        style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Type</label>
                                    <select id="doc-type"
                                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
                                        <option value="policy">Policy Document</option>
                                        <option value="audit">Audit Report</option>
                                        <option value="evidence">Compliance Evidence</option>
                                    </select>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <label
                                        style="display: block; font-size: 0.875rem; font-weight: 500; margin-bottom: 0.5rem;">Document
                                        File</label>
                                    <input type="file" id="doc-file"
                                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: white;">
                                </div>
                                <button type="submit" class="btn-primary" style="width: 100%;">Upload Document</button>
                            </form>
                        </div>

                        <!-- List Section -->
                        <div>
                            <h4 style="margin-bottom: 1rem;">Recent Documents</h4>
                            <div id="document-list" style="display: flex; flex-direction: column; gap: 1rem;">
                                <!-- Dynamic List -->
                                <p style="color: #6b7280;">Loading documents...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 5: SUMMARY (Placeholder) -->
            <div id="tab-summary" class="tab-content hidden">
                <div class="card" style="text-align: center; padding: 4rem;">
                    <h3>Executive Summary</h3>
                    <p>Report generation coming soon...</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal Dialog -->
    <div id="user-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">User Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer" id="modal-footer">
                <!-- Dynamic buttons -->
            </div>
        </div>
    </div>

    <script>
        let allDocuments = [];
        let allAccessUsers = [];
        let allCompaniesData = []; // Store all companies data for filtering/sorting
        let companiesReportCounts = {}; // Store report counts per company
        const API_URL = 'http://localhost:5000/api';
        let token = localStorage.getItem('token');
        let charts = {};

        if (token) checkAuth();

        async function checkAuth() {
            try {
                const res = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const user = await res.json();
                    initDashboard(user);
                } else {
                    logout();
                }
            } catch { logout(); }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();

                if (res.ok) {
                    token = data.access_token;
                    localStorage.setItem('token', token);
                    initDashboard(data.user);
                } else {
                    document.getElementById('login-error').textContent = data.error;
                    document.getElementById('login-error').classList.remove('hidden');
                }
            } catch (err) {
                console.error(err);
            }
        }

        function logout() {
            localStorage.removeItem('token');
            location.reload();
        }

        async function handleRegister(e) {
            e.preventDefault();
            const firstname = document.getElementById('reg-firstname').value;
            const lastname = document.getElementById('reg-lastname').value;
            const username = document.getElementById('reg-username').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;

            try {
                const res = await fetch(`${API_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username,
                        email,
                        password,
                        first_name: firstname,
                        last_name: lastname,
                        role: 'user'
                    })
                });
                const data = await res.json();

                if (res.ok) {
                    document.getElementById('register-success').textContent = "Registration successful! You can now login.";
                    document.getElementById('register-success').classList.remove('hidden');
                    document.getElementById('register-error').classList.add('hidden');
                    e.target.reset();
                    setTimeout(() => toggleAuth('login'), 1500);
                } else {
                    document.getElementById('register-error').textContent = data.error;
                    document.getElementById('register-error').classList.remove('hidden');
                    document.getElementById('register-success').classList.add('hidden');
                }
            } catch (err) {
                console.error(err);
                document.getElementById('register-error').textContent = "Registration failed. Try again.";
                document.getElementById('register-error').classList.remove('hidden');
            }
        }

        function toggleAuth(view) {
            if (view === 'register') {
                document.getElementById('login-card').classList.add('hidden');
                document.getElementById('register-card').classList.remove('hidden');
            } else {
                document.getElementById('register-card').classList.add('hidden');
                document.getElementById('login-card').classList.remove('hidden');
            }
            document.getElementById('login-error').classList.add('hidden');
            document.getElementById('register-error').classList.add('hidden');
            document.getElementById('register-success').classList.add('hidden');
        }

        function initDashboard(user) {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('user-display').textContent = user.username;
            fetchOverviewData(); // Load overview data on initial dashboard load
        }

        async function fetchDashboardData() {
            try {
                // Fetch Compliance Overview Data
                const res = await fetch(`${API_URL}/companies/compliance-overview`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    const data = await res.json();

                    // Calculate overall averages
                    const companies = data.companies;
                    const totalCompliance = Math.round(companies.reduce((acc, c) => acc + c.average_compliance, 0) / companies.length) || 0;

                    // Update Overall Compliance Card
                    document.getElementById('rt-score-compliance').textContent = `${totalCompliance}%`;
                    document.getElementById('rt-bar-compliance').style.width = `${totalCompliance}%`;
                    document.getElementById('rt-trend-compliance').textContent = `Based on ${data.total_companies} companies`;

                    // Update timestamp
                    if (document.getElementById('rt-timestamp')) {
                        document.getElementById('rt-timestamp').textContent = `Last Sync: ${new Date().toLocaleTimeString()}`;
                    }

                    // Update Data Quality Card (using average of ISO 27001 info security as proxy for quality)
                    const qualityScore = Math.round(companies.reduce((acc, c) => acc + c.compliance_scores.iso27001.information_security, 0) / companies.length) || 0;
                    document.getElementById('rt-score-quality').textContent = `${qualityScore}%`;
                    document.getElementById('rt-bar-quality').style.width = `${qualityScore}%`;
                    document.getElementById('rt-trend-quality').textContent = `+${Math.round(Math.random() * 5)}% from last month`; // Simulated trend

                    // Update Alerts (Simulated based on low scores)
                    const lowScoreCount = companies.filter(c => c.average_compliance < 70).length;
                    const activeAlerts = lowScoreCount + 3; // Base alerts + low performing companies
                    if (document.getElementById('score-alerts')) {
                        document.getElementById('score-alerts').textContent = activeAlerts;
                    }

                    // Update Pending Reviews (based on report count)
                    const totalReports = companies.reduce((acc, c) => acc + c.report_count, 0);
                    if (document.getElementById('score-reviews')) {
                        document.getElementById('score-reviews').textContent = Math.round(totalReports / 5); // Simulated pending reviews
                    }

                    // Render Compliance Trend Chart
                    renderComplianceChart(data.companies);
                }
            } catch (err) {
                console.error('Error fetching dashboard data:', err);
            }
        }

        // --- OVERVIEW TAB DATA ---
        async function fetchOverviewData() {
            try {
                // Fetch companies count
                const companiesRes = await fetch(`${API_URL}/companies?per_page=100`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const companiesData = await companiesRes.json();
                const totalCompanies = companiesData.companies ? companiesData.companies.length : 0;

                // Fetch all reports to count statuses
                const reportsRes = await fetch(`${API_URL}/reports/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const reportsData = await reportsRes.json();
                const allReports = reportsData.reports || [];

                // Calculate metrics
                const approvedReports = allReports.filter(r => r.status === 'approved').length;
                const pendingReports = allReports.filter(r => r.status === 'submitted').length;
                const rejectedReports = allReports.filter(r => r.status === 'rejected').length;
                const totalReports = allReports.length;

                // Calculate compliance score (approved / total)
                const complianceScore = totalReports > 0 ? Math.round((approvedReports / totalReports) * 100) : 0;

                // Calculate data quality score based on reports with descriptions
                const reportsWithDesc = allReports.filter(r => r.description && r.description.trim().length > 0).length;
                const qualityScore = totalReports > 0 ? Math.round((reportsWithDesc / totalReports) * 100) : 0;

                // Update Real-Time Compliance
                document.getElementById('rt-score-compliance').textContent = `${complianceScore}%`;
                document.getElementById('rt-trend-compliance').textContent = `${approvedReports} approved of ${totalReports}`;
                document.getElementById('rt-bar-compliance').style.width = `${complianceScore}%`;
                document.getElementById('rt-timestamp').textContent = `Last updated: ${new Date().toLocaleString()}`;

                // Update Security Quality Score
                document.getElementById('rt-score-quality').textContent = `${qualityScore}%`;
                document.getElementById('rt-trend-quality').textContent = `${reportsWithDesc} with metadata`;
                document.getElementById('rt-bar-quality').style.width = `${qualityScore}%`;

                // Update Active Alerts (using rejected as alerts)
                document.getElementById('score-alerts').textContent = rejectedReports;
                document.getElementById('trend-alerts').textContent = `${rejectedReports} total rejected`;
                // For demo, distribute alerts randomly
                const highAlerts = Math.floor(rejectedReports * 0.3);
                const medAlerts = Math.floor(rejectedReports * 0.4);
                const lowAlerts = rejectedReports - highAlerts - medAlerts;
                document.getElementById('alert-high').textContent = highAlerts;
                document.getElementById('alert-med').textContent = medAlerts;
                document.getElementById('alert-low').textContent = lowAlerts;

                // Update Pending Reviews
                document.getElementById('score-reviews').textContent = pendingReports;

                // Update charts if Chart.js is available
                updateOverviewCharts(companiesData, allReports);

            } catch (err) {
                console.error('Error fetching overview data:', err);
                document.getElementById('rt-score-compliance').textContent = 'Error';
                document.getElementById('rt-score-quality').textContent = 'Error';
            }
        }

        function updateOverviewCharts(companiesData, reports) {
            // Compliance Trend Chart (mock data based on report statuses)
            const complianceTrendCtx = document.getElementById('complianceChart');
            if (complianceTrendCtx && typeof Chart !== 'undefined') {
                if (charts.compliance) charts.compliance.destroy();
                charts.compliance = new Chart(complianceTrendCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Compliance Score',
                            data: [65, 70, 75, 80, 85, Math.round((reports.filter(r => r.status === 'approved').length / reports.length) * 100)],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, max: 100 }
                        }
                    }
                });
            }

            // ISO 27001 Controls Chart
            const iso27001Ctx = document.getElementById('iso27001Chart');
            if (iso27001Ctx && typeof Chart !== 'undefined') {
                if (charts.iso27001) charts.iso27001.destroy();
                const approved = reports.filter(r => r.status === 'approved').length;
                const pending = reports.filter(r => r.status === 'submitted').length;
                const rejected = reports.filter(r => r.status === 'rejected').length;

                charts.iso27001 = new Chart(iso27001Ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Approved', 'Pending', 'Rejected'],
                        datasets: [{
                            data: [approved, pending, rejected],
                            backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            }
        }

        // --- TAB LOGIC ---
        function switchTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            // Remove active class from buttons
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            // Show selected
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            // Highlight button
            const index = ['overview', 'compliance', 'companies', 'data-quality', 'access', 'documents', 'summary'].indexOf(tabId);
            if (document.querySelectorAll('.tab-btn')[index]) {
                document.querySelectorAll('.tab-btn')[index].classList.add('active');
            }

            if (tabId === 'overview') {
                fetchOverviewData();
            } else if (tabId === 'documents') {
                fetchDocuments();
            } else if (tabId === 'compliance') {
                populateComplianceCompanyFilter();
                displayOverviewCompliance();
            } else if (tabId === 'companies') {
                fetchCompanies();
            } else if (tabId === 'data-quality') {
                fetchAllCompaniesCompliance();
            } else if (tabId === 'access') {
                fetchComplianceDocs();
                fetchUsers(); // Fetch users for the access control table
                fetchAllDocuments(); // Fetch all uploaded documents
            }
        }

        async function fetchComplianceDocs() {
            const container = document.getElementById('submitted-docs-list');
            try {
                // container.innerHTML = '<p style="color: #6b7280; font-style: italic;">Loading pending reviews...</p>'; // Optional: Reset loading state
                const res = await fetch(`${API_URL}/reports/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (res.ok && data.reports) {
                    const submitted = data.reports.filter(r => r.status === 'submitted' || r.status === 'reviewed' || r.status === 'approved');
                    console.log('Fetched API Reports:', data.reports.length, 'Submitted:', submitted.length);

                    if (document.getElementById('debug-doc-count')) {
                        document.getElementById('debug-doc-count').textContent = `Found: ${submitted.length} / ${data.reports.length}`;
                    }

                    if (submitted.length > 0) {
                        container.innerHTML = submitted.map(doc => {
                            // Extract company ticker from filename for AnnualReports.com link
                            let companyTicker = '';
                            let annualReportsUrl = 'https://www.annualreports.com/';

                            if (doc.file_path) {
                                const filename = doc.file_path.split('/').pop();
                                const match = filename.match(/(?:NYSE_|NASDAQ_)?([A-Za-z]+)(?:_\d{4})?\.pdf/i);
                                if (match) {
                                    companyTicker = match[1];
                                    annualReportsUrl = `https://www.annualreports.com/Companies?search=${companyTicker}`;
                                }
                            }

                            return `
                            <div class="card" style="padding: 1rem; border: 1px solid #e5e7eb;">
                                <div style="font-weight: 600;">${doc.title}</div>
                                <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">${doc.report_type}</div>
                                <div style="margin-top: 0.5rem;">
                                    <span class="badge badge-${doc.status === 'approved' ? 'success' : (doc.status === 'rejected' ? 'low' : 'medium')}">${doc.status}</span>
                                    ${doc.file_path ? `<a href="${annualReportsUrl}" target="_blank" style="font-size: 0.8rem; color: #2563eb; margin-left: 0.5rem;" title="View on AnnualReports.com${companyTicker ? ' - ' + companyTicker : ''}">View Report</a>` : ''}
                                </div>
                                <div style="margin-top: 1rem; padding-top: 0.5rem; border-top: 1px solid #f3f4f6; display: flex; gap: 0.5rem;">
                                    <button onclick='handleApproveDocument(${JSON.stringify(doc).replace(/'/g, "\\'")})' class="btn-sm" style="background: #d1fae5; color: #047857; border: none; font-size: 0.75rem;">Approve</button>
                                    <button onclick='handleRejectDocument(${JSON.stringify(doc).replace(/'/g, "\\'")})' class="btn-sm" style="background: #fee2e2; color: #dc2626; border: none; font-size: 0.75rem;">Reject</button>
                                    <button onclick="deleteReport(${doc.id})" class="btn-sm" style="background: white; border: 1px solid #e5e7eb; color: #6b7280; font-size: 0.75rem;">Delete</button>
                                </div>
                            </div>
                        `}).join('');
                    } else {
                        container.innerHTML = '<p style="color: #666; font-style: italic;">No submitted documents pending review.</p>';
                    }
                } else {
                    console.error('Failed to fetch reports:', data);
                    container.innerHTML = `<p style="color: #ef4444;">Error loading reviews: ${data.error || res.statusText}</p>`;
                }
            } catch (err) {
                console.error(err);
                container.innerHTML = `<p style="color: #ef4444;">Network error loading reviews.</p>`;
            }
        }

        async function fetchAllDocuments() {
            const container = document.getElementById('all-docs-list');
            try {
                const res = await fetch(`${API_URL}/reports/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (res.ok && data.reports) {
                    console.log('Fetched All Documents:', data.reports.length);

                    if (document.getElementById('uploaded-docs-count')) {
                        document.getElementById('uploaded-docs-count').textContent = `Total: ${data.reports.length}`;
                    }

                    if (data.reports.length > 0) {
                        container.innerHTML = data.reports.map(doc => {
                            const statusColor = doc.status === 'approved' ? 'success' :
                                (doc.status === 'rejected' ? 'low' :
                                    (doc.status === 'submitted' ? 'medium' : 'low'));

                            const hasFile = doc.file_path && doc.file_path !== '';

                            // Extract company ticker from filename for AnnualReports.com link
                            let companyTicker = '';
                            if (hasFile && doc.file_path) {
                                // Extract filename from path (e.g., "uploads/NYSE_ALSN_2023.pdf" -> "NYSE_ALSN_2023.pdf")
                                const filename = doc.file_path.split('/').pop();

                                // Try to extract ticker from patterns like:
                                // "NYSE_ALSN_2023.pdf" -> "ALSN"
                                // "alsn_2023.pdf" -> "alsn"
                                const match = filename.match(/(?:NYSE_|NASDAQ_)?([A-Za-z]+)(?:_\d{4})?\.pdf/i);
                                if (match) {
                                    companyTicker = match[1];
                                }
                            }

                            // Generate AnnualReports.com search URL
                            const annualReportsUrl = companyTicker
                                ? `https://www.annualreports.com/Companies?search=${companyTicker}`
                                : 'https://www.annualreports.com/';

                            return `
                            <div class="card" style="padding: 1rem; border: 1px solid #e5e7eb;">
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">${doc.title}</div>
                                <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">${doc.report_type}</div>
                                <div style="margin-bottom: 0.75rem;">
                                    <span class="badge badge-${statusColor}">${doc.status.toUpperCase()}</span>
                                    ${hasFile ?
                                    `<span class="badge badge-success" style="margin-left: 0.5rem;">üìé File Uploaded</span>` :
                                    `<span class="badge" style="margin-left: 0.5rem; background: #f3f4f6; color: #6b7280;">No File</span>`
                                }
                                </div>
                                ${doc.description ? `<p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 0.75rem;">${doc.description}</p>` : ''}
                                <div style="display: flex; gap: 0.5rem; align-items: center;">
                                    ${hasFile ?
                                    `<a href="${annualReportsUrl}" target="_blank" class="btn-sm" style="background: #2563eb; color: white; text-decoration: none; border: none; font-size: 0.75rem;" title="View on AnnualReports.com${companyTicker ? ' - ' + companyTicker : ''}">üìÑ View Report</a>` :
                                    ''
                                }
                                    <span style="font-size: 0.75rem; color: #9ca3af; margin-left: auto;">
                                        ${new Date(doc.created_at).toLocaleDateString()}
                                    </span>
                                </div>
                            </div>
                        `}).join('');
                    } else {
                        container.innerHTML = '<p style="color: #666; font-style: italic;">No documents found.</p>';
                    }
                } else {
                    console.error('Failed to fetch documents:', data);
                    container.innerHTML = `<p style="color: #ef4444;">Error loading documents: ${data.error || res.statusText}</p>`;
                }
            } catch (err) {
                console.error(err);
                container.innerHTML = `<p style="color: #ef4444;">Network error loading documents.</p>`;
            }
        }


        async function handleUpload(e) {
            e.preventDefault();
            const title = document.getElementById('doc-title').value;
            const description = document.getElementById('doc-desc').value;
            const type = document.getElementById('doc-type').value;
            const fileInput = document.getElementById('doc-file');

            const formData = new FormData();
            formData.append('title', title);
            formData.append('description', description);
            formData.append('report_type', type);
            if (fileInput.files[0]) {
                formData.append('file', fileInput.files[0]);
            }

            try {
                const res = await fetch(`${API_URL}/reports/`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }, // No Content-Type header manually set for FormData
                    body: formData
                });

                if (res.ok) {
                    alert('Document uploaded successfully');
                    e.target.reset();
                    fetchDocuments();
                } else {
                    const data = await res.json();
                    // JWT Extended uses 'msg', my API uses 'error'
                    const errorMsg = data.error || data.msg || 'Unknown error';
                    alert(`Upload Failed: ${res.status} ${res.statusText}\n${errorMsg}`);
                }
            } catch (err) {
                console.error(err);
                alert(`Network Error: ${err.message}`);
            }
        }

        async function fetchDocuments() {
            try {
                const res = await fetch(`${API_URL}/reports/`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                const container = document.getElementById('document-list');
                if (data.reports && data.reports.length > 0) {
                    container.innerHTML = data.reports.map(doc => `
                        <div class="card" style="padding: 1rem; border: 1px solid #e5e7eb; box-shadow: none;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                <div>
                                    <h5 style="font-size: 1rem; font-weight: 600; margin-bottom: 0.25rem;">${doc.title}</h5>
                                    <p style="color: #6b7280; font-size: 0.85rem; margin-bottom: 0.5rem;">${doc.description || 'No description'}</p>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <span class="badge badge-low">${doc.report_type}</span>
                                        <span class="badge badge-${doc.status === 'approved' ? 'success' : 'medium'}">${doc.status}</span>
                                    </div>
                                </div>
                                ${doc.status === 'draft' ?
                            `<button class="btn-sm btn-white" onclick="updateReportStatus(${doc.id}, 'submitted')">Submit</button>` :
                            (doc.status === 'submitted' ? '<span style="color: #6b7280; font-size: 0.8rem;">Submitted</span>' : '')
                        }
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="color: #6b7280; font-style: italic;">No documents found.</p>';
                }
            } catch (err) {
                console.error(err);
            }
        }


        async function fetchCompanies() {
            try {
                const res = await fetch(`${API_URL}/companies?per_page=100`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                const container = document.getElementById('companies-list');
                if (data.companies && data.companies.length > 0) {
                    const totalCompanies = data.companies.length;

                    // Update statistics display
                    document.getElementById('total-companies-count').textContent = totalCompanies;

                    container.innerHTML = data.companies.map(company => `
                        <div class="card" style="padding: 1.5rem; border: 2px solid #e5e7eb;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div>
                                    <h4 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem;">
                                        ${company.name}
                                    </h4>
                                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                        ${company.ticker ? `<span class="badge badge-success">${company.ticker}</span>` : ''}
                                        ${company.exchange ? `<span class="badge badge-low">${company.exchange}</span>` : ''}
                                        ${company.industry ? `<span class="badge badge-medium">${company.industry}</span>` : ''}
                                    </div>
                                </div>
                                ${company.website ? `
                                    <a href="${company.website}" target="_blank" class="btn-sm btn-white">
                                        Visit Website
                                    </a>
                                ` : ''}
                            </div>
                            
                            ${company.description ? `
                                <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem; line-height: 1.5;">
                                    ${company.description.substring(0, 200)}${company.description.length > 200 ? '...' : ''}
                                </p>
                            ` : ''}
                            
                            <div style="border-top: 1px solid #e5e7eb; padding-top: 1rem; margin-top: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                    <h5 style="font-weight: 600; font-size: 0.95rem;">Annual Reports</h5>
                                    <span class="badge badge-success" id="company-${company.id}-count">Loading...</span>
                                </div>
                                <div id="company-${company.id}-reports" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.5rem;">
                                    <span style="color: #9ca3af; font-size: 0.875rem;">Loading reports...</span>
                                </div>
                            </div>
                        </div>
                    `).join('');

                    // Store companies data globally for filtering/sorting
                    allCompaniesData = data.companies;

                    // Fetch reports for each company and calculate total reports
                    let totalReports = 0;
                    const reportPromises = data.companies.map(async (company) => {
                        const count = await fetchCompanyReports(company.id);
                        companiesReportCounts[company.id] = count; // Store count
                        return count;
                    });

                    // Wait for all report fetches to complete
                    const reportCounts = await Promise.all(reportPromises);
                    totalReports = reportCounts.reduce((sum, count) => sum + count, 0);

                    // Update total reports count
                    document.getElementById('total-reports-count').textContent = totalReports;
                    document.getElementById('stats-summary').textContent = `Data from AnnualReports.com ‚Ä¢ Last updated: ${new Date().toLocaleDateString()}`;

                    // Initial filter count update
                    document.getElementById('filtered-count').textContent = data.companies.length;
                } else {
                    // Update with zero counts
                    document.getElementById('total-companies-count').textContent = '0';
                    document.getElementById('total-reports-count').textContent = '0';
                    document.getElementById('stats-summary').textContent = 'No data available';

                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #9ca3af;">
                            <p style="font-size: 1.1rem; margin-bottom: 1rem;">No companies found in database</p>
                            <p style="font-size: 0.9rem;">Run <code>population_companies.py</code> to scrape data from AnnualReports.com</p>
                        </div>
                    `;
                }
            } catch (err) {
                console.error(err);
                document.getElementById('companies-list').innerHTML = `
                    <p style="color: #ef4444;">Error loading companies: ${err.message}</p>
                `;
            }
        }

        async function fetchCompanyReports(companyId) {
            try {
                const res = await fetch(`${API_URL}/companies/${companyId}/reports`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                const container = document.getElementById(`company-${companyId}-reports`);
                const countBadge = document.getElementById(`company-${companyId}-count`);

                if (data.reports && data.reports.length > 0) {
                    countBadge.textContent = `${data.reports.length} Reports`;

                    // Show only recent 10 reports
                    const recentReports = data.reports.slice(0, 10);
                    container.innerHTML = recentReports.map(report => `
                        <div style="background: #f9fafb; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid #e5e7eb;">
                            <div style="font-weight: 600; font-size: 0.85rem;">${report.year}</div>
                            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">${report.report_type || 'Annual Report'}</div>
                            ${report.pdf_url ? `
                                <a href="${report.pdf_url}" target="_blank" style="font-size: 0.75rem; color: #2563eb; display: inline-block; margin-top: 0.25rem;">
                                    View PDF
                                </a>
                            ` : ''}
                        </div>
                    `).join('');

                    if (data.reports.length > 10) {
                        container.innerHTML += `
                            <div style="grid-column: 1 / -1; text-align: center; color: #6b7280; font-size: 0.85rem; padding: 0.5rem;">
                                + ${data.reports.length - 10} more reports
                            </div>
                        `;
                    }

                    return data.reports.length; // Return count for statistics
                } else {
                    countBadge.textContent = '0 Reports';
                    container.innerHTML = '<span style="color: #9ca3af; font-size: 0.875rem;">No reports available</span>';
                    return 0; // Return 0 if no reports
                }
            } catch (err) {
                console.error(err);
                return 0; // Return 0 on error
            }
        }

        function filterAndSortCompanies() {
            if (!allCompaniesData || allCompaniesData.length === 0) return;

            const searchTerm = document.getElementById('company-search').value.toLowerCase();
            const sortOption = document.getElementById('company-sort').value;

            // Filter companies
            let filteredCompanies = allCompaniesData.filter(company => {
                const nameMatch = company.name.toLowerCase().includes(searchTerm);
                const tickerMatch = company.ticker && company.ticker.toLowerCase().includes(searchTerm);
                return nameMatch || tickerMatch;
            });

            // Sort companies
            filteredCompanies.sort((a, b) => {
                switch (sortOption) {
                    case 'name-asc':
                        return a.name.localeCompare(b.name);
                    case 'name-desc':
                        return b.name.localeCompare(a.name);
                    case 'reports-desc':
                        const countA = companiesReportCounts[a.id] || 0;
                        const countB = companiesReportCounts[b.id] || 0;
                        return countB - countA;
                    case 'reports-asc':
                        const countA2 = companiesReportCounts[a.id] || 0;
                        const countB2 = companiesReportCounts[b.id] || 0;
                        return countA2 - countB2;
                    case 'ticker-asc':
                        const tickerA = a.ticker || '';
                        const tickerB = b.ticker || '';
                        return tickerA.localeCompare(tickerB);
                    default:
                        return 0;
                }
            });

            // Update filtered count
            document.getElementById('filtered-count').textContent = filteredCompanies.length;
            document.getElementById('filtered-label').textContent = filteredCompanies.length === 1 ? 'company' : 'companies';

            // Render filtered and sorted companies
            const container = document.getElementById('companies-list');
            if (filteredCompanies.length > 0) {
                container.innerHTML = filteredCompanies.map(company => `
                    <div class="card" style="padding: 1.5rem; border: 2px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <div>
                                <h4 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.5rem;">
                                    ${company.name}
                                </h4>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    ${company.ticker ? `<span class="badge badge-success">${company.ticker}</span>` : ''}
                                    ${company.exchange ? `<span class="badge badge-low">${company.exchange}</span>` : ''}
                                    ${company.industry ? `<span class="badge badge-medium">${company.industry}</span>` : ''}
                                </div>
                            </div>
                            ${company.website ? `
                                <a href="${company.website}" target="_blank" class="btn-sm btn-white">
                                    Visit Website
                                </a>
                            ` : ''}
                        </div>
                        
                        ${company.description ? `
                            <p style="color: #6b7280; font-size: 0.9rem; margin-bottom: 1rem; line-height: 1.5;">
                                ${company.description.substring(0, 200)}${company.description.length > 200 ? '...' : ''}
                            </p>
                        ` : ''}
                        
                        <div style="border-top: 1px solid #e5e7eb; padding-top: 1rem; margin-top: 1rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <h5 style="font-weight: 600; font-size: 0.95rem;">Annual Reports</h5>
                                <span class="badge badge-success" id="company-${company.id}-count">${companiesReportCounts[company.id] || 0} Reports</span>
                            </div>
                            <div id="company-${company.id}-reports" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.5rem;">
                                <span style="color: #9ca3af; font-size: 0.875rem;">Reports already loaded</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #9ca3af;">
                        <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">No companies match your search</p>
                        <p style="font-size: 0.9rem;">Try a different search term</p>
                    </div>
                `;
            }
        }


        async function updateReportStatus(id, newStatus) {
            try {
                const res = await fetch(`${API_URL}/reports/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (res.ok) {
                    alert(`Document ${newStatus} successfully!`);
                    fetchDocuments();        // Refresh user's document list
                    fetchComplianceDocs();   // Refresh admin's pending review list
                } else {
                    const data = await res.json();
                    alert(data.error || 'Update failed');
                }
            } catch (err) {
                console.error(err);
                alert('Network error');
            }
        }

        async function deleteReport(id) {
            if (!confirm('Are you sure you want to delete this document? This action cannot be undone.')) {
                return;
            }

            try {
                const res = await fetch(`${API_URL}/reports/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (res.ok) {
                    alert('Document deleted successfully!');
                    fetchDocuments();        // Refresh user's document list
                    fetchComplianceDocs();   // Refresh admin's pending review list
                } else {
                    const data = await res.json();
                    alert(data.error || 'Delete failed');
                }
            } catch (err) {
                console.error(err);
                alert('Network error');
            }
        }

        async function handleApproveDocument(doc) {
            // Show custom approval dialog
            const modal = document.getElementById('user-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');

            modalTitle.textContent = 'Approve Document';

            modalBody.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <p style="color: #374151; margin-bottom: 1rem;">Please confirm the document details before approval:</p>
                    
                    <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1rem;">
                        <div style="margin-bottom: 0.75rem;">
                            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.25rem;">Document Title:</label>
                            <div style="color: #6b7280;">${doc.title}</div>
                        </div>
                        
                        <div style="margin-bottom: 0.75rem;">
                            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.25rem;">Report Type:</label>
                            <select id="approve-report-type" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                <option value="audit" ${doc.report_type === 'audit' ? 'selected' : ''}>Annual Reports</option>
                                <option value="policy" ${doc.report_type === 'policy' ? 'selected' : ''}>Policy Documents</option>
                                <option value="evidence" ${doc.report_type === 'evidence' ? 'selected' : ''}>Compliance Evidence</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 0.75rem;">
                            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.25rem;">Company Name: <span style="color: #dc2626;">*</span></label>
                            <input type="text" id="approve-company-name" placeholder="Enter company name (e.g., Allison Transmission)" 
                                style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"
                                value="">
                        </div>
                        
                        <div>
                            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.25rem;">Report Year: <span style="color: #dc2626;">*</span></label>
                            <input type="number" id="approve-report-year" placeholder="Enter year (e.g., 2023)" 
                                min="1900" max="2100"
                                style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;"
                                value="2023">
                        </div>
                    </div>
                    
                    <p style="font-size: 0.875rem; color: #6b7280;">
                        <strong>Note:</strong> This will mark the document as approved and associate it with the specified company.
                    </p>
                </div>
            `;

            modalFooter.innerHTML = `
                <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-confirm" onclick="confirmApproval(${doc.id})">Confirm Approval</button>
            `;

            modal.classList.remove('hidden');
        }

        async function confirmApproval(docId) {
            const reportType = document.getElementById('approve-report-type').value;
            const companyName = document.getElementById('approve-company-name').value.trim();
            const reportYear = parseInt(document.getElementById('approve-report-year').value);

            if (!companyName) {
                alert('Please enter a company name');
                return;
            }

            if (!reportYear || reportYear < 1900 || reportYear > 2100) {
                alert('Please enter a valid report year');
                return;
            }

            closeModal();

            try {
                const res = await fetch(`${API_URL}/reports/${docId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: 'approved',
                        report_type: reportType,
                        company_name: companyName,
                        report_year: reportYear,
                        description: `Approved for ${companyName} - ${reportType} (${reportYear})`
                    })
                });

                if (res.ok) {
                    const data = await res.json();
                    let message = `Document approved successfully for ${companyName} (${reportYear})!`;

                    if (data.warning) {
                        message += `\n\n‚ö†Ô∏è ${data.warning}`;
                    } else {
                        message += `\n\n‚úÖ Company and annual report have been added to the Companies tab.`;
                    }

                    alert(message);
                    fetchDocuments();
                    fetchComplianceDocs();
                } else {
                    const data = await res.json();
                    alert(data.error || 'Approval failed');
                }
            } catch (err) {
                console.error(err);
                alert('Network error');
            }
        }

        async function handleRejectDocument(doc) {
            // Show custom rejection dialog
            const modal = document.getElementById('user-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');

            modalTitle.textContent = 'Reject Document';

            modalBody.innerHTML = `
                <div style="margin-bottom: 1.5rem;">
                    <div style="background: #fef2f2; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #dc2626; margin-bottom: 1rem;">
                        <div style="font-weight: 600; color: #991b1b; margin-bottom: 0.25rem;">Document:</div>
                        <div style="color: #7f1d1d;">${doc.title}</div>
                    </div>
                    
                    <div>
                        <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem;">
                            Reason for Rejection: <span style="color: #dc2626;">*</span>
                        </label>
                        <textarea id="reject-reason" rows="4" placeholder="Please provide a detailed reason for rejecting this document..."
                            style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem; resize: vertical;"></textarea>
                    </div>
                    
                    <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.75rem;">
                        <strong>Note:</strong> The submitter will be notified of this rejection and the reason provided.
                    </p>
                </div>
            `;

            modalFooter.innerHTML = `
                <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button class="btn-confirm" style="background: #dc2626;" onclick="confirmRejection(${doc.id})">Confirm Rejection</button>
            `;

            modal.classList.remove('hidden');
        }

        async function confirmRejection(docId) {
            const rejectionReason = document.getElementById('reject-reason').value.trim();

            if (!rejectionReason) {
                alert('Please provide a reason for rejection');
                return;
            }

            closeModal();

            try {
                const res = await fetch(`${API_URL}/reports/${docId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: 'rejected',
                        description: `Rejected: ${rejectionReason}`
                    })
                });

                if (res.ok) {
                    alert('Document rejected successfully!');
                    fetchDocuments();
                    fetchComplianceDocs();
                } else {
                    const data = await res.json();
                    alert(data.error || 'Rejection failed');
                }
            } catch (err) {
                console.error(err);
                alert('Network error');
            }
        }


        // --- COMPANY-BASED COMPLIANCE FILTERING ---


        // Populate company dropdown when compliance tab is opened
        async function populateComplianceCompanyFilter() {
            try {
                const res = await fetch(`${API_URL}/companies?per_page=100`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    allCompaniesData = data.companies || [];

                    const select = document.getElementById('compliance-company-filter');
                    const currentValue = select.value;

                    // Keep "All Companies" option and add companies
                    const companiesHTML = allCompaniesData.map(company =>
                        `<option value="${company.id}">${company.name} (${company.ticker || 'N/A'})</option>`
                    ).join('');

                    select.innerHTML = `<option value="">All Companies (Overview)</option>${companiesHTML}`;
                    select.value = currentValue; // Restore previous selection

                    // Show total count
                    document.getElementById('compliance-company-info').textContent =
                        `${allCompaniesData.length} companies available`;
                }
            } catch (err) {
                console.error('Failed to load companies:', err);
            }
        }

        async function filterComplianceByCompany() {
            const companyId = document.getElementById('compliance-company-filter').value;
            const infoEl = document.getElementById('compliance-company-info');

            if (!companyId) {
                // Show overview for all companies
                infoEl.textContent = `${allCompaniesData.length} companies available - Showing overview`;
                displayOverviewCompliance();
            } else {
                // Show company-specific compliance
                const company = allCompaniesData.find(c => c.id == companyId);
                if (company) {
                    infoEl.innerHTML = `<strong>${company.name}</strong> - ${company.industry || 'Unknown Industry'}`;
                    await displayCompanyCompliance(companyId, company);
                }
            }
        }

        function displayOverviewCompliance() {
            // Calculate average compliance across all companies
            const iso27001List = document.getElementById('iso27001-list');
            const iso27017List = document.getElementById('iso27017-list');
            const soc2List = document.getElementById('soc2-list');
            const policyList = document.getElementById('policy-list');

            // Default overview values (could be calculated from all companies)
            iso27001List.innerHTML = `
                <div class="control-item"><span>Access Control</span><span class="badge badge-success">92%</span></div>
                <div class="control-item"><span>Information Security</span><span class="badge badge-success">88%</span></div>
                <div class="control-item"><span>Operations Security</span><span class="badge badge-warning">75%</span></div>
            `;

            iso27017List.innerHTML = `
                <div class="control-item"><span>Cloud Access Control</span><span class="badge badge-success">90%</span></div>
                <div class="control-item"><span>Virtual Network Security</span><span class="badge badge-success">85%</span></div>
                <div class="control-item"><span>Cloud Asset Management</span><span class="badge badge-warning">70%</span></div>
            `;

            soc2List.innerHTML = `
                <div class="control-item"><span>Security</span><span class="badge badge-success">91%</span></div>
                <div class="control-item"><span>Availability</span><span class="badge badge-success">89%</span></div>
                <div class="control-item"><span>Processing Integrity</span><span class="badge badge-success">86%</span></div>
                <div class="control-item"><span>Confidentiality</span><span class="badge badge-warning">78%</span></div>
                <div class="control-item"><span>Privacy</span><span class="badge badge-success">93%</span></div>
            `;

            policyList.innerHTML = `
                <div class="control-item"><span>Privacy Policy</span><span class="small-text">95% completed</span></div>
                <div class="control-item"><span>Security Policy</span><span class="small-text">88% completed</span></div>
                <div class="control-item"><span>Data Handling Policy</span><span class="small-text">82% completed</span></div>
            `;
        }

        async function fetchAllCompaniesCompliance() {
            try {
                const res = await fetch(`${API_URL}/companies/compliance-overview`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    const data = await res.json();

                    // Update key metrics
                    document.getElementById('total-companies-count').textContent = data.total_companies;

                    // Calculate overall average
                    const overallAvg = Math.round(data.companies.reduce((acc, c) => acc + c.average_compliance, 0) / data.total_companies);
                    document.getElementById('average-compliance-score').textContent = `${overallAvg}%`;

                    // Find highest score
                    const highest = data.companies[0]?.average_compliance || 0;
                    document.getElementById('highest-compliance-score').textContent = `${highest}%`;

                    // Render Chart Bars
                    const container = document.getElementById('companies-compliance-chart');
                    container.innerHTML = data.companies.map(company => `
                        <div style="margin-bottom: 1rem;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 0.25rem;">
                                <div style="font-weight: 500;">${company.name}</div>
                                <div style="color: #666;">${company.average_compliance}%</div>
                            </div>
                            <div style="height: 0.75rem; background: #e5e7eb; border-radius: 999px; overflow: hidden;">
                                <div style="width: ${company.average_compliance}%; height: 100%; background: ${getGradient(company.average_compliance)}; border-radius: 999px;"></div>
                            </div>
                        </div>
                    `).join('');
                }
            } catch (err) {
                console.error('Error fetching compliance overview:', err);
                document.getElementById('companies-compliance-chart').innerHTML = '<div style="color: #ef4444; padding: 1rem;">Failed to load compliance data</div>';
            }
        }

        function getGradient(score) {
            if (score >= 90) return 'linear-gradient(90deg, #10b981 0%, #059669 100%)';
            if (score >= 75) return 'linear-gradient(90deg, #3b82f6 0%, #2563eb 100%)';
            if (score >= 60) return 'linear-gradient(90deg, #f59e0b 0%, #d97706 100%)';
            return 'linear-gradient(90deg, #ef4444 0%, #dc2626 100%)';
        }

        async function displayCompanyCompliance(companyId, company) {
            try {
                // Call AI-powered compliance analysis endpoint
                const res = await fetch(`${API_URL}/companies/${companyId}/compliance`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    const data = await res.json();
                    const scores = data.compliance_scores;

                    // Display company-specific compliance using AI-generated scores
                    const iso27001List = document.getElementById('iso27001-list');
                    const iso27017List = document.getElementById('iso27017-list');
                    const soc2List = document.getElementById('soc2-list');
                    const policyList = document.getElementById('policy-list');

                    // ISO 27001 Controls
                    const iso = scores.iso27001;
                    iso27001List.innerHTML = `
                        <div class="control-item"><span>Access Control</span><span class="badge ${getBadgeClass(iso.access_control)}">${iso.access_control}%</span></div>
                        <div class="control-item"><span>Information Security</span><span class="badge ${getBadgeClass(iso.information_security)}">${iso.information_security}%</span></div>
                        <div class="control-item"><span>Operations Security</span><span class="badge ${getBadgeClass(iso.operations_security)}">${iso.operations_security}%</span></div>
                        <div style="margin-top: 0.5rem; padding: 0.5rem; background: #e8f4fd; border-left: 3px solid #3b82f6; border-radius: 0.25rem; font-size: 0.8rem; color: #1e40af;">
                            <strong>ü§ñ AI Analysis:</strong> Based on ${data.report_count} report${data.report_count !== 1 ? 's' : ''} | ${data.industry} industry benchmarks
                        </div>
                    `;

                    // ISO/IEC 27017 Cloud Controls
                    const cloud = scores.iso27017;
                    iso27017List.innerHTML = `
                        <div class="control-item"><span>Cloud Access Control</span><span class="badge ${getBadgeClass(cloud.cloud_access_control)}">${cloud.cloud_access_control}%</span></div>
                        <div class="control-item"><span>Virtual Network Security</span><span class="badge ${getBadgeClass(cloud.virtual_network_security)}">${cloud.virtual_network_security}%</span></div>
                        <div class="control-item"><span>Cloud Asset Management</span><span class="badge ${getBadgeClass(cloud.cloud_asset_management)}">${cloud.cloud_asset_management}%</span></div>
                    `;

                    // SOC 2 Trust Service Criteria
                    const soc2 = scores.soc2;
                    soc2List.innerHTML = `
                        <div class="control-item"><span>Security</span><span class="badge ${getBadgeClass(soc2.security)}">${soc2.security}%</span></div>
                        <div class="control-item"><span>Availability</span><span class="badge ${getBadgeClass(soc2.availability)}">${soc2.availability}%</span></div>
                        <div class="control-item"><span>Processing Integrity</span><span class="badge ${getBadgeClass(soc2.processing_integrity)}">${soc2.processing_integrity}%</span></div>
                        <div class="control-item"><span>Confidentiality</span><span class="badge ${getBadgeClass(soc2.confidentiality)}">${soc2.confidentiality}%</span></div>
                        <div class="control-item"><span>Privacy</span><span class="badge ${getBadgeClass(soc2.privacy)}">${soc2.privacy}%</span></div>
                    `;

                    // Policies
                    const policies = scores.policies;
                    policyList.innerHTML = `
                        <div class="control-item"><span>Privacy Policy</span><span class="small-text">${policies.privacy_policy}% completed</span></div>
                        <div class="control-item"><span>Security Policy</span><span class="small-text">${policies.security_policy}% completed</span></div>
                        <div class="control-item"><span>Data Handling Policy</span><span class="small-text">${policies.data_handling_policy}% completed</span></div>
                    `;
                } else {
                    // Fallback to basic display on error
                    console.error('Failed to load AI compliance data');
                    document.getElementById('iso27001-list').innerHTML = '<div style="color: #ef4444; padding: 1rem;">Unable to load compliance data</div>';
                }
            } catch (err) {
                console.error('Compliance analysis error:', err);
                document.getElementById('iso27001-list').innerHTML = '<div style="color: #ef4444; padding: 1rem;">Error analyzing compliance data</div>';
            }
        }

        function getBadgeClass(percentage) {
            if (percentage >= 85) return 'badge-success';
            if (percentage >= 70) return 'badge-warning';
            return 'badge-danger';
        }


        async function fetchDashboardData() {
            const res = await fetch(`${API_URL}/dashboard/overview`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();

            // --- OVERVIEW DATA ---
            updateMetric('compliance', data.metrics.compliance);
            updateMetric('quality', data.metrics.data_quality);

            document.getElementById('score-alerts').textContent = data.metrics.active_alerts.value;
            document.getElementById('trend-alerts').textContent = `${data.metrics.active_alerts.change} from last week`;
            document.getElementById('alert-high').textContent = data.metrics.active_alerts.breakdown.high;
            document.getElementById('alert-med').textContent = data.metrics.active_alerts.breakdown.medium;
            document.getElementById('alert-low').textContent = data.metrics.active_alerts.breakdown.low;
            document.getElementById('score-reviews').textContent = data.metrics.pending_reviews.value;

            renderCharts(data.charts);
            renderActivity(data.recent_activity);

            // --- COMPLIANCE TAB DATA ---
            if (data.compliance_details) {
                renderComplianceList('iso27001-list', data.compliance_details.iso_27001);
                renderComplianceList('iso27017-list', data.compliance_details.iso_27017);
                renderPolicyList('policy-list', data.compliance_details.policies);
            }

            // --- ACCESS CONTROL DATA ---
            if (data.access_control) {
                renderAccessTable(data.access_control);
            }
        }


        async function fetchUsers() {
            try {
                const res = await fetch(`${API_URL}/admin/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    const data = await res.json();

                    // Transform user data to match the access control table format
                    const users = data.users.map(user => ({
                        name: user.first_name && user.last_name
                            ? `${user.first_name} ${user.last_name}`
                            : user.username,
                        role: user.role.charAt(0).toUpperCase() + user.role.slice(1),
                        permissions: getPermissionsForRole(user.role),
                        last_access: formatLastAccess(user.created_at), // Using created_at as proxy
                        status: 'Active' // All users active by default
                    }));

                    renderAccessTable(users);
                } else {
                    console.error('Failed to fetch users:', await res.json());
                    // Show empty state with error message
                    document.getElementById('access-table-body').innerHTML = `
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 2rem; color: #ef4444;">
                                <div style="font-size: 1rem;">Failed to load users</div>
                                <div style="font-size: 0.875rem; margin-top: 0.5rem;">Please check your permissions</div>
                            </td>
                        </tr>
                    `;
                }
            } catch (err) {
                console.error('Error fetching users:', err);
                document.getElementById('access-table-body').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: #ef4444;">
                            <div style="font-size: 1rem;">Network error</div>
                            <div style="font-size: 0.875rem; margin-top: 0.5rem;">Could not connect to the server</div>
                        </td>
                    </tr>
                `;
            }
        }

        function getPermissionsForRole(role) {
            const permissions = {
                'admin': 'Full Access, User Management, Report Review',
                'user': 'Read/Write, Document Upload',
                'viewer': 'Read Only'
            };
            return permissions[role] || 'Standard Access';
        }

        function formatLastAccess(lastLogin) {
            if (!lastLogin) return 'Never';

            const date = new Date(lastLogin);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;

            return date.toLocaleDateString();
        }

        function renderAccessTable(users) {
            allAccessUsers = users; // Store for filtering
            const tbody = document.getElementById('access-table-body');
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td><div style="font-weight: 500;">${user.name}</div></td>
                    <td>${user.role}</td>
                    <td>${user.permissions}</td>
                    <td>${user.last_access}</td>
                    <td><span class="status-${user.status.toLowerCase()}">${user.status}</span></td>
                    <td>
                        <button class="btn-sm btn-white" onclick='handleUserAction(${JSON.stringify(user)})'>${user.status === 'Pending' ? 'Review' : 'View'}</button>
                    </td>
                </tr>
            `).join('');
        }

        function filterAccessTable() {
            const searchTerm = document.getElementById('user-search').value.toLowerCase();
            const roleFilter = document.getElementById('role-filter').value;
            const timeFilter = parseInt(document.getElementById('time-filter').value);

            // Filter users based on all criteria
            const filtered = allAccessUsers.filter(user => {
                // Search filter (name, role, or permissions)
                const matchesSearch = !searchTerm ||
                    user.name.toLowerCase().includes(searchTerm) ||
                    user.role.toLowerCase().includes(searchTerm) ||
                    user.permissions.toLowerCase().includes(searchTerm);

                // Role filter
                const matchesRole = !roleFilter || user.role === roleFilter;

                // Time filter (simplified - in real app would parse actual dates)
                const matchesTime = true; // For demo, accept all times
                // In production: parse user.last_access and compare with timeFilter days

                return matchesSearch && matchesRole && matchesTime;
            });

            // Re-render table with filtered results WITHOUT overwriting allAccessUsers
            const tbody = document.getElementById('access-table-body');
            if (filtered.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 2rem; color: #9ca3af;">
                            <div style="font-size: 1rem;">No users found matching your criteria</div>
                            <div style="font-size: 0.875rem; margin-top: 0.5rem;">Try adjusting your search or filters</div>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = filtered.map(user => `
                    <tr>
                        <td><div style="font-weight: 500;">${user.name}</div></td>
                        <td>${user.role}</td>
                        <td>${user.permissions}</td>
                        <td>${user.last_access}</td>
                        <td><span class="status-${user.status.toLowerCase()}">${user.status}</span></td>
                        <td>
                            <button class="btn-sm btn-white" onclick='handleUserAction(${JSON.stringify(user)})'>${user.status === 'Pending' ? 'Review' : 'View'}</button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        function handleUserAction(user) {
            const actionType = user.status === 'Pending' ? 'Review' : 'View';
            const modal = document.getElementById('user-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalFooter = document.getElementById('modal-footer');

            // Set modal title
            modalTitle.textContent = `${actionType} User Details`;

            // Build modal body with user details
            modalBody.innerHTML = `
                <div class="modal-detail-row">
                    <div class="modal-detail-label">Name:</div>
                    <div class="modal-detail-value">${user.name}</div>
                </div>
                <div class="modal-detail-row">
                    <div class="modal-detail-label">Role:</div>
                    <div class="modal-detail-value">${user.role}</div>
                </div>
                <div class="modal-detail-row">
                    <div class="modal-detail-label">Permissions:</div>
                    <div class="modal-detail-value">${user.permissions}</div>
                </div>
                <div class="modal-detail-row">
                    <div class="modal-detail-label">Last Access:</div>
                    <div class="modal-detail-value">${user.last_access}</div>
                </div>
                <div class="modal-detail-row">
                    <div class="modal-detail-label">Status:</div>
                    <div class="modal-detail-value"><span class="status-${user.status.toLowerCase()}">${user.status}</span></div>
                </div>
            `;

            // Build modal footer based on status
            if (user.status === 'Pending') {
                modalFooter.innerHTML = `
                    <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                    <button class="btn-confirm" onclick="approveUser('${user.name}')">Approve User</button>
                `;
            } else {
                modalFooter.innerHTML = `
                    <button class="btn-confirm" onclick="closeModal()">Close</button>
                `;
            }

            // Show modal
            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('user-modal').classList.add('hidden');
        }

        function approveUser(userName) {
            closeModal();
            // Show success message in modal
            setTimeout(() => {
                const modal = document.getElementById('user-modal');
                const modalTitle = document.getElementById('modal-title');
                const modalBody = document.getElementById('modal-body');
                const modalFooter = document.getElementById('modal-footer');

                modalTitle.textContent = 'Success!';
                modalBody.innerHTML = `
                    <div style="text-align: center; padding: 1rem;">
                        <div style="font-size: 3rem; color: var(--success-color); margin-bottom: 1rem;">‚úì</div>
                        <p style="font-size: 1.1rem; font-weight: 500; margin-bottom: 0.5rem;">User Approved</p>
                        <p style="color: var(--text-secondary);">User ${userName} has been successfully approved!</p>
                    </div>
                `;
                modalFooter.innerHTML = `
                    <button class="btn-confirm" onclick="closeModal()">OK</button>
                `;

                modal.classList.remove('hidden');
            }, 100);
            // In a real app, you would call an API here to update the user status
            // await fetch(`${API_URL}/users/${user.id}/approve`, { method: 'POST', ... });
        }

        let complianceChartInstance = null;

        function renderComplianceChart(companies) {
            const ctx = document.getElementById('complianceChart').getContext('2d');

            // Calculate current average
            const currentAvg = Math.round(companies.reduce((acc, c) => acc + c.average_compliance, 0) / companies.length) || 0;

            // Simulate 6-month history converging to current score
            const history = [];
            for (let i = 5; i >= 0; i--) {
                // Random fluctuation that stabilizes towards the end
                const fluctuation = Math.random() * (i * 2) - i;
                history.push(Math.min(100, Math.max(0, Math.round(currentAvg - (i * 1.5) + fluctuation))));
            }
            // Ensure last point is exactly current
            history[5] = currentAvg;

            const months = ['Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan'];

            if (complianceChartInstance) {
                complianceChartInstance.destroy();
            }

            complianceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Compliance Score',
                        data: history,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            grid: { borderDash: [2, 2] }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function updateMetric(id, data) {
            document.getElementById(`score-${id}`).textContent = `${data.value}%`;
            document.getElementById(`trend-${id}`).textContent = `+${data.change}% from last month`;
            document.getElementById(`bar-${id}`).style.width = `${data.value}%`;
        }

        function renderComplianceList(containerId, items) {
            const container = document.getElementById(containerId);
            container.innerHTML = items.map(item => `
                <div class="control-item">
                    <span class="control-name">${item.name}</span>
                    <span class="badge-score bg-${item.status === 'warning' ? 'warning' : 'good'}">${item.score}%</span>
                </div>
            `).join('');
        }

        function renderPolicyList(containerId, items) {
            const container = document.getElementById(containerId);
            container.innerHTML = items.map(item => `
                <div class="control-item">
                    <span class="control-name">${item.name}</span>
                    <span class="policy-status">${item.completion}% completed</span>
                </div>
            `).join('');
        }

        function renderCharts(data) {
            // Destroy existing charts if any (to prevent overlap on refresh)
            // For simplicity in this demo, we assume fresh load or just overwrite

            // Line Chart
            const ctx1 = document.getElementById('complianceChart').getContext('2d');
            new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: data.compliance_trend.labels,
                    datasets: [{
                        label: 'Compliance Score',
                        data: data.compliance_trend.score,
                        borderColor: '#10b981',
                        tension: 0.4
                    }, {
                        label: 'Alerts',
                        data: data.compliance_trend.alerts,
                        borderColor: '#ef4444',
                        tension: 0.4
                    }]
                },
                options: { maintainAspectRatio: false }
            });

            // Pie Chart
            const ctx2 = document.getElementById('controlsChart').getContext('2d');
            new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Implemented', 'In Progress', 'Not Started'],
                    datasets: [{
                        data: [
                            data.iso_controls.implemented,
                            data.iso_controls.in_progress,
                            data.iso_controls.not_started
                        ],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
                    }]
                },
                options: { maintainAspectRatio: false }
            });

            // Data Quality Bar Chart
            if (data.data_quality_details) {
                const ctx3 = document.getElementById('qualityChart').getContext('2d');
                new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: ['Completeness', 'Accuracy', 'Consistency', 'Timeliness'],
                        datasets: [{
                            label: 'Quality Score',
                            data: [
                                data.data_quality_details.completeness,
                                data.data_quality_details.accuracy,
                                data.data_quality_details.consistency,
                                data.data_quality_details.timeliness
                            ],
                            backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#6366f1'],
                            borderRadius: 4
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { x: { min: 0, max: 100 } }
                    }
                });
            }
        }

        function renderActivity(items) {
            const container = document.getElementById('activity-feed');
            container.innerHTML = items.map(item => `
                <div class="activity-item">
                    <div class="activity-icon icon-${item.status === 'danger' ? 'danger' : 'success'}">
                        ${item.status === 'danger' ? '‚ö°' : '‚úì'}
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${item.type}</div>
                        <div class="activity-time">${item.timestamp}</div>
                    </div>
                    <span class="badge badge-${item.priority}">${item.priority}</span>
                </div>
            `).join('');
        }
    </script>
</body>

</html>