<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Governance Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- Login Section -->
    <div id="auth-section" class="container login-container">
        <div class="card">
            <h2>Sign In</h2>
            <div id="login-error" class="hidden" style="color: red; margin-bottom: 1rem;"></div>
            <form onsubmit="handleLogin(event)">
                <div>
                    <label>Username</label>
                    <input type="text" id="username" placeholder="admin" required>
                </div>
                <div>
                    <label>Password</label>
                    <input type="password" id="password" placeholder="admin123" required>
                </div>
                <button type="submit" class="btn-primary btn-full">Login to Platform</button>
            </form>
            <p style="text-align: center; color: #666; font-size: 0.875rem; margin-top: 1rem;">
                Try: admin/admin123 or user/user123
            </p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app-container" class="hidden">
        <header>
            <div class="logo-section">
                <div class="logo-icon">üõ°Ô∏è</div>
                <div class="header-title">
                    <h1>Data Governance & Compliance Platform</h1>
                    <div class="header-subtitle">ISO 27001 / ISO/IEC 27017</div>
                </div>
            </div>
            <div class="user-controls">
                <button class="btn-outline">
                    <span id="system-status">System Active</span>
                </button>
                <div id="user-display" style="font-weight: 500;"></div>
                <button onclick="logout()" class="btn-primary" style="font-size: 0.875rem;">Logout</button>
            </div>
        </header>

        <div class="container">
            <!-- Tabs -->
            <div class="tabs-container">
                <button class="tab-btn active" onclick="switchTab('overview')">Overview</button>
                <button class="tab-btn" onclick="switchTab('compliance')">Compliance</button>
                <button class="tab-btn" onclick="switchTab('data-quality')">Data Quality</button>
                <button class="tab-btn" onclick="switchTab('access')">Access Control</button>
                <button class="tab-btn" onclick="switchTab('summary')">Summarize</button>
            </div>

            <!-- TAB 1: OVERVIEW -->
            <div id="tab-overview" class="tab-content">
                <!-- Metrics Row -->
                <div class="metrics-grid">
                    <!-- Compliance Card -->
                    <div class="card">
                        <div class="metric-header">
                            <span class="metric-title">Overall Compliance</span>
                            <span class="icon-success">‚úî</span>
                        </div>
                        <div class="metric-value" id="score-compliance">--%</div>
                        <div class="metric-trend trend-up">
                            <span>‚Üó</span> <span id="trend-compliance">+0% from last month</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="bar-compliance" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Data Quality Card -->
                    <div class="card">
                        <div class="metric-header">
                            <span class="metric-title">Data Quality Score</span>
                            <span style="color: #2563eb">‚ö°</span>
                        </div>
                        <div class="metric-value" id="score-quality">--%</div>
                        <div class="metric-trend trend-up">
                            <span>‚Üó</span> <span id="trend-quality">+0% from last month</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="bar-quality" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- Active Alerts -->
                    <div class="card">
                        <div class="metric-header">
                            <span class="metric-title">Active Alerts</span>
                            <span class="text-danger">‚ö†</span>
                        </div>
                        <div class="metric-value" id="score-alerts">--</div>
                        <div class="metric-trend trend-down">
                            <span>‚Üò</span> <span id="trend-alerts">-0 from last week</span>
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <span class="badge badge-high">High: <span id="alert-high">0</span></span>
                            <span class="badge badge-medium">Med: <span id="alert-med">0</span></span>
                            <span class="badge badge-low">Low: <span id="alert-low">0</span></span>
                        </div>
                    </div>

                    <!-- Pending Reviews -->
                    <div class="card">
                        <div class="metric-header">
                            <span class="metric-title">Pending Reviews</span>
                            <span class="text-warning">üïí</span>
                        </div>
                        <div class="metric-value" id="score-reviews">--</div>
                        <div class="metric-trend">
                            <span style="color: #666">Requires attention</span>
                        </div>
                        <button class="btn-outline"
                            style="width: 100%; justify-content: center; margin-top: 1rem;">Review Now</button>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="charts-grid">
                    <div class="card">
                        <h3>Compliance Trend</h3>
                        <p style="color: #666; font-size: 0.875rem; margin-bottom: 1rem;">6-month performance overview
                        </p>
                        <div class="chart-container">
                            <canvas id="complianceChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h3>ISO 27001 Controls</h3>
                        <p style="color: #666; font-size: 0.875rem; margin-bottom: 1rem;">Implementation status</p>
                        <div class="chart-container" style="display: flex; justify-content: center;">
                            <canvas id="controlsChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <h3>Recent Activity</h3>
                    <div class="activity-list" id="activity-feed">
                        <!-- Dynamic items -->
                    </div>
                </div>
            </div>

            <!-- TAB 2: COMPLIANCE -->
            <div id="tab-compliance" class="tab-content hidden">
                <div class="card">
                    <h3>Compliance Controls</h3>
                    <p style="color: #666; font-size: 0.9rem;">ISO 27001 and ISO/IEC 27017 compliance monitoring</p>

                    <div class="compliance-grid">
                        <!-- Column 1 -->
                        <div class="control-group">
                            <h4>ISO 27001 Controls</h4>
                            <div id="iso27001-list"></div>
                        </div>

                        <!-- Column 2 -->
                        <div class="control-group">
                            <h4>ISO/IEC 27017 Cloud Controls</h4>
                            <div id="iso27017-list"></div>
                        </div>

                        <!-- Column 3 -->
                        <div class="control-group">
                            <h4>Policy Acknowledgments</h4>
                            <div id="policy-list"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 3: DATA QUALITY (Placeholder) -->
            <div id="tab-data-quality" class="tab-content hidden">
                <div class="card" style="text-align: center; padding: 4rem;">
                    <h3>Data Quality Dashboard</h3>
                    <p>Metrics coming soon...</p>
                </div>
            </div>

            <!-- TAB 4: ACCESS (Placeholder) -->
            <div id="tab-access" class="tab-content hidden">
                <div class="card" style="text-align: center; padding: 4rem;">
                    <h3>Access Control Dashboard</h3>
                    <p>Metrics coming soon...</p>
                </div>
            </div>

            <!-- TAB 5: SUMMARY (Placeholder) -->
            <div id="tab-summary" class="tab-content hidden">
                <div class="card" style="text-align: center; padding: 4rem;">
                    <h3>Executive Summary</h3>
                    <p>Report generation coming soon...</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000/api';
        let token = localStorage.getItem('token');
        let charts = {};

        if (token) checkAuth();

        async function checkAuth() {
            try {
                const res = await fetch(`${API_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.ok) {
                    const user = await res.json();
                    initDashboard(user);
                } else {
                    logout();
                }
            } catch { logout(); }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const res = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();

                if (res.ok) {
                    token = data.access_token;
                    localStorage.setItem('token', token);
                    initDashboard(data.user);
                } else {
                    document.getElementById('login-error').textContent = data.error;
                    document.getElementById('login-error').classList.remove('hidden');
                }
            } catch (err) {
                console.error(err);
            }
        }

        function logout() {
            localStorage.removeItem('token');
            location.reload();
        }

        function initDashboard(user) {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('user-display').textContent = user.username;
            fetchDashboardData();
        }

        // --- TAB LOGIC ---
        function switchTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            // Remove active class from buttons
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            // Show selected
            document.getElementById(`tab-${tabId}`).classList.remove('hidden');
            // Highlight button (simple logic for now)
            const index = ['overview', 'compliance', 'data-quality', 'access', 'summary'].indexOf(tabId);
            document.querySelectorAll('.tab-btn')[index].classList.add('active');
        }

        async function fetchDashboardData() {
            const res = await fetch(`${API_URL}/dashboard/overview`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();

            // --- OVERVIEW DATA ---
            updateMetric('compliance', data.metrics.compliance);
            updateMetric('quality', data.metrics.data_quality);

            document.getElementById('score-alerts').textContent = data.metrics.active_alerts.value;
            document.getElementById('trend-alerts').textContent = `${data.metrics.active_alerts.change} from last week`;
            document.getElementById('alert-high').textContent = data.metrics.active_alerts.breakdown.high;
            document.getElementById('alert-med').textContent = data.metrics.active_alerts.breakdown.medium;
            document.getElementById('alert-low').textContent = data.metrics.active_alerts.breakdown.low;
            document.getElementById('score-reviews').textContent = data.metrics.pending_reviews.value;

            renderCharts(data.charts);
            renderActivity(data.recent_activity);

            // --- COMPLIANCE TAB DATA ---
            if (data.compliance_details) {
                renderComplianceList('iso27001-list', data.compliance_details.iso_27001);
                renderComplianceList('iso27017-list', data.compliance_details.iso_27017);
                renderPolicyList('policy-list', data.compliance_details.policies);
            }
        }

        function updateMetric(id, data) {
            document.getElementById(`score-${id}`).textContent = `${data.value}%`;
            document.getElementById(`trend-${id}`).textContent = `+${data.change}% from last month`;
            document.getElementById(`bar-${id}`).style.width = `${data.value}%`;
        }

        function renderComplianceList(containerId, items) {
            const container = document.getElementById(containerId);
            container.innerHTML = items.map(item => `
                <div class="control-item">
                    <span class="control-name">${item.name}</span>
                    <span class="badge-score bg-${item.status === 'warning' ? 'warning' : 'good'}">${item.score}%</span>
                </div>
            `).join('');
        }

        function renderPolicyList(containerId, items) {
            const container = document.getElementById(containerId);
            container.innerHTML = items.map(item => `
                <div class="control-item">
                    <span class="control-name">${item.name}</span>
                    <span class="policy-status">${item.completion}% completed</span>
                </div>
            `).join('');
        }

        function renderCharts(data) {
            // Destroy existing charts if any (to prevent overlap on refresh)
            // For simplicity in this demo, we assume fresh load or just overwrite

            // Line Chart
            const ctx1 = document.getElementById('complianceChart').getContext('2d');
            new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: data.compliance_trend.labels,
                    datasets: [{
                        label: 'Compliance Score',
                        data: data.compliance_trend.score,
                        borderColor: '#10b981',
                        tension: 0.4
                    }, {
                        label: 'Alerts',
                        data: data.compliance_trend.alerts,
                        borderColor: '#ef4444',
                        tension: 0.4
                    }]
                },
                options: { maintainAspectRatio: false }
            });

            // Pie Chart
            const ctx2 = document.getElementById('controlsChart').getContext('2d');
            new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Implemented', 'In Progress', 'Not Started'],
                    datasets: [{
                        data: [
                            data.iso_controls.implemented,
                            data.iso_controls.in_progress,
                            data.iso_controls.not_started
                        ],
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444']
                    }]
                },
                options: { maintainAspectRatio: false }
            });
        }

        function renderActivity(items) {
            const container = document.getElementById('activity-feed');
            container.innerHTML = items.map(item => `
                <div class="activity-item">
                    <div class="activity-icon icon-${item.status === 'danger' ? 'danger' : 'success'}">
                        ${item.status === 'danger' ? '‚ö°' : '‚úì'}
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${item.type}</div>
                        <div class="activity-time">${item.timestamp}</div>
                    </div>
                    <span class="badge badge-${item.priority}">${item.priority}</span>
                </div>
            `).join('');
        }
    </script>
</body>

</html>